<!--
@license
Copyright (c) 2016 The Jviz Project Authors. All rights reserved.
The Jviz Project is under the MIT License. See https://github.com/jviz/jviz/blob/dev/LICENSE
-->

<!-- Import elements -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../jviz/jviz.html">
<link rel="import" href="../jviz-styles/jviz-styles.html">
<link rel="import" href="../jviz-icons/jviz-icons.html">

<!-- Import elements -->
<link rel="import" href="./jviz-select-option.html">

<!-- Select element -->
<dom-module id="jviz-select">
  <template>
    <style>
      /* Host variables */
      :host
      {
        --jviz-select-width: 0px;
        --jviz-select-height: 0px;
        --jviz-select-color-background: var(--jviz-navy);
        --jviz-select-color-text: var(--jviz-navy-over);
        position: relative;
      }

      /* Select style */
      :host .select
      {
        display: inline-block;
        width: calc(20px + var(--jviz-select-width));
        height: 20px;
        position: relative;
        line-height: 20px;
        padding-left: 5px;
        padding-right: 5px;
        padding-top: 5px;
        padding-bottom: 5px;
        border-radius: 5px;
        color: var(--jviz-select-color-text) !important;
        background-color: var(--jviz-select-color-background);
        cursor: pointer;
      }

      /* Options is visible */
      :host[visible] .select
      {
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
      }

      /* Select text */
      :host .select .text
      {
        display: inline-block;
        float: right;
        text-decoration: none;
        font-family: var(--jviz-font-family);
        font-size: 14px;
        font-weight: bold;
        padding-left: 5px;
        width: calc(var(--jviz-select-width) - 5px);
      }

      /* Options list */
      :host .options
      {
        display: none;
        position: absolute;
        top: 20px;
        left: 0px;
        color: var(--jviz-select-color-text) !important;
        background-color: var(--jviz-select-color-background) !important;
        width: calc(30px + var(--jviz-select-width));
        height: var(--jviz-select-height);
        border-bottom-right-radius: 5px;
        border-bottom-left-radius: 5px;
        overflow-y: auto;
      }

      /* Select is visible */
      :host[visible] .options
      {
        display: block;
      }
    </style>
    <!-- Select element -->
    <div id="select" class="select" on-tap="toggle">
      <!-- Icon -->
      <jviz-icons icon="chevron_down" color$="{{ color }}" size="20px" reflect></jviz-icons>
      <!-- Text value -->
      <div class="text">{{ text }}</div>
    </div>
    <!-- Options wrapper -->
    <div id="options" class="options">
      <content select="jviz-select-option"></content>
    </div>
  </template>
</dom-module>

<!-- Select logic -->
<script>
  //Initialize the select object
  var jviz_select = { is: 'jviz-select' };

  //Select properties
  jviz_select.properties = {};
  jviz_select.properties.color = { type: String, reflectToAttribute: true, observer: '_update_color', value: 'navy' };
  jviz_select.properties.width = { type: String, reflectToAttribute: true, observer: '_update_width', value: '50px' };
  jviz_select.properties.maxOptions = { type: Number, reflectToAttribute: true, value: 5 };
  jviz_select.properties.value = { type: String, observer: '_update_value', value: '' };
  jviz_select.properties.text = { type: String, value: '' };
  jviz_select.properties.visible = { type: Boolean, reflectToAttribute: true, value: false };

  //Attached event
  jviz_select.attached = function()
  {
    //Get this
    var self = this;

    //Get all the options
    this.$.options.querySelectorAll('jviz-select-option').forEach(function(el)
    {
      //Add the event listener
      el.addEventListener('mousedown', function(){ return self._option(el); });

      //Check if this option is selected
      if(el.selected === true)
      {
        //Add the value
        self.value = el.value;
      }
    });
  };

  //Open-close the options
  jviz_select.toggle = function()
  {
    //Show/Hide the options
    this.visible = !this.visible;

    //Check if now is visible
    if(this.visible === true)
    {
      //Get the number ov available options
      var num_options = this.$.options.querySelectorAll('jviz-select-option').length;

      //Get the value
      var value = (num_options < this.maxOptions) ? num_options * 30 : this.maxOptions * 30;

      //Update the height
      this.customStyle['--jviz-select-height'] = value + 'px';

      //Update the styles
      this.updateStyles();
    }
  };

  //Update the select color
  jviz_select._update_color = function(value)
  {
    //Update the button background color
    this.customStyle['--jviz-select-color-background'] = 'var(--jviz-' + value + ')';

    //Update the button text color
    this.customStyle['--jviz-select-color-text'] = 'var(--jviz-' + value + '-over)';

    //Update the styles
    this.updateStyles();
  };

  //Update the select value
  jviz_select._update_value = function(value)
  {
    //Save this
    var self = this;

    //Get the options list
    this.$.options.querySelectorAll('jviz-select-option').forEach(function(el)
    {
      //check if the value attribute exists
      if(el.value === null){ return true; }

      //Check if the value is the same
      if(el.value !== value){ return true; }

      //Update the select text
      self.text = el.text;

      //Exit
      return false;
    });
  };

  //Update the select width
  jviz_select._update_width = function(value)
  {
    //Add the width value
    this.customStyle['--jviz-select-width'] = value.replace('px', '').replace('%', '') + 'px';

    //Update the styles
    this.updateStyles();
  };

  //Clicked on a option
  jviz_select._option = function(el)
  {
    //Check the value
    if(this.value !== el.value)
    {
      //Update the select value
      this.value = el.value;

      //Fire the change event
      this.fire('change', { value: this.value }, {});
    }

    //Hide the options list
    this.toggle();
  };

  //Register the select element
  Polymer(jviz_select);
</script>